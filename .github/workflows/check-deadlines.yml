name: Decidoo Cron Jobs

# Ce workflow appelle tous les endpoints cron pour automatiser la gestion des d√©cisions

on:
  schedule:
    # Toutes les 15 minutes - V√©rifier les deadlines
    - cron: '*/15 * * * *'

    # Quotidien √† 9h UTC - Envoyer des rappels
    - cron: '0 9 * * *'

    # Quotidien √† 2h UTC - Nettoyer les tokens expir√©s
    - cron: '0 2 * * *'

  # Permet de d√©clencher manuellement le workflow
  workflow_dispatch:
    inputs:
      job:
        description: 'Quel job ex√©cuter?'
        required: true
        type: choice
        default: 'all'
        options:
          - all
          - check-deadlines
          - check-consent-stages
          - send-reminders
          - cleanup-tokens

jobs:
  check-deadlines:
    name: Fermer les d√©cisions expir√©es
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '*/15 * * * *' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.job == 'all' || github.event.inputs.job == 'check-deadlines')

    steps:
      - name: Fermer les d√©cisions expir√©es
        run: |
          echo "üîÑ V√©rification des d√©cisions expir√©es..."
          response=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            ${{ secrets.RAILWAY_URL }}/api/cron/check-deadlines)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå check-deadlines failed with status $http_code"
            exit 1
          fi

          echo "‚úÖ check-deadlines completed successfully"

  check-consent-stages:
    name: V√©rifier les stages CONSENT
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '*/15 * * * *' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.job == 'all' || github.event.inputs.job == 'check-consent-stages')

    steps:
      - name: V√©rifier les stages de consentement
        run: |
          echo "üîÑ V√©rification des stages de consentement..."
          response=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            ${{ secrets.RAILWAY_URL }}/api/cron/check-consent-stages)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå check-consent-stages failed with status $http_code"
            exit 1
          fi

          echo "‚úÖ check-consent-stages completed successfully"

  send-reminders:
    name: Envoyer des rappels avant deadline
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 9 * * *' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.job == 'all' || github.event.inputs.job == 'send-reminders')

    steps:
      - name: Envoyer des rappels de deadline
        run: |
          echo "üìß Envoi des rappels de deadline..."
          response=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            ${{ secrets.RAILWAY_URL }}/api/cron/send-reminders)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå send-reminders failed with status $http_code"
            exit 1
          fi

          echo "‚úÖ send-reminders completed successfully"

  cleanup-tokens:
    name: Nettoyer les tokens expir√©s
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 2 * * *' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.job == 'all' || github.event.inputs.job == 'cleanup-tokens')

    steps:
      - name: Nettoyer les tokens et donn√©es expir√©es
        run: |
          echo "üóëÔ∏è Nettoyage des tokens expir√©s..."
          response=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            ${{ secrets.RAILWAY_URL }}/api/cron/cleanup-tokens)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå cleanup-tokens failed with status $http_code"
            exit 1
          fi

          echo "‚úÖ cleanup-tokens completed successfully"
